<?xml version="1.0" encoding="windows-1251" standalone="yes" ?>
<triggers>

	<!-- Инициализация карты -->
	<trigger Name="GlobalVar" active="1">
		<event	timeout="0.01"		eventid="GE_TIME_PERIOD" />
		<script>
			SetVar("AutoSaveCount", 0)
			if QuestStatus("LastIspytanie_Quest3")==Q_TAKEN then
				local vehPlayer = GetPlayerVehicle()
				if vehPlayer then
					vehPlayer:SetGamePositionOnGround( CVector(1034.896, 272.785, 1918.175))
					vehPlayer:setGodMode(1)
				end
			
				CreateVehicleEx("LabirintUral","LABCAR",CVector(3424.383, 257.493, 2010.854), 1100)
				local vehL = GetEntityByName("LABCAR")
				if vehL then
					vehL:SetRotation(Quaternion(0.001, -0.082, 0.000, 0.997))
					vehL:SetRandomSkin()
				end
				
				TActivate("LabirintChange11")
			
				trigger:Deactivate()
			end
			
		</script>
	</trigger>

	<!-- Автосейв перед началом лабиринта -->
	<trigger Name="trAutoSave" active="0">
		<event	timeout="1"		eventid="GE_TIME_PERIOD" />
		<script>
			if GetVar("AutoSaveCount").AsInt == 0 then
				SetVar("AutoSaveCount", 1)
				AutoSave(STR_LABYRINTH)
			else
				AllowSave(false)
			end

			TActivate("trActivateEasyMode")

			trigger:Deactivate()
		</script>
	</trigger>

	<!-- Смена машины на лабиринтскую -->
	<trigger Name="LabirintChange11" active="0">
		<event	timeout="0.01"		eventid="GE_TIME_PERIOD" />
		<script>
			SetVar("GarVehName","LABCAR")

			local excarname="LABCAR"
			local oldcarname="OldCarPlayer2"

			GetPlayerVehicle():SetNameFromScript( oldcarname )

			SaveWeaponGroups()

			local veh=getObj(excarname)
			local oldveh=GetPlayerVehicle()

			if veh then
				GetPlayerVehicle():setGodMode(1)
				GetPlayerVehicle():SetCustomControlEnabled(1)
				CapturePlayerVehicle(0, "garage")
   				g_Player:AddChild(veh)
				GetPlayerVehicle():setGodMode(1)
				GetPlayerVehicle():SetCustomControlEnabled(0)
			end

			if oldveh then
			   oldveh:setGodMode(1)
			end

			SetVar("GarVehName",oldcarname)

			GetPlayerVehicle():setGodMode(0)
			GetPlayerVehicle():AddItemsToRepository("add_stability_and_speed2", 2)

			TActivate("NachRolikBegin")
			
			trigger:Deactivate()
		</script>
	</trigger>

	<!-- Имплементация Easy Mode -->
	<trigger Name="trActivateEasyMode" active="0">
		<event	timeout="0.01"		eventid="GE_TIME_PERIOD" />
		<script>
			trigger:Deactivate()

			local file, error, code = io.open("data\\maps\\r1m7\\labyrinth.txt", "r")
			if not file then
				return
			end

			file:close()

			local b = SpawnMessageBox("8801")
			if b ~= 1 then
				return
			end

			TActivate("trCreateHelpers")
		</script>
	</trigger>

	<trigger Name="trCreateHelpers" active="0">
		<event	timeout="0.01"		eventid="GE_TIME_PERIOD" />
		<script>
			trigger:Deactivate()

			CreateNewDummyObject("arena_barricade12", "lab_hint_1", -1, -1, CVector(2199.144, 267.094, 1654.627), Quaternion(0.7071, -0.0015, -0.7071, -0.0015), 0)
			CreateNewDummyObject("arena_barricade12", "lab_hint_2", -1, -1, CVector(2655.886, 254.524, 1796.959), Quaternion(0.1332, -0.6068, -0.0914, 0.7783), 0)
			CreateNewDummyObject("arena_barricade12", "lab_hint_3", -1, -1, CVector(3146.504, 264.916, 1782.607), Quaternion(0.0000, 0.0175, 0.0000, 0.9998), 0)
			CreateNewDummyObject("arena_barricade12", "lab_hint_4", -1, -1, CVector(2917.665, 254.475, 1586.790), Quaternion(-0.0486, 0.7497, -0.1184, 0.6493), 0)
			CreateNewDummyObject("arena_barricade12", "lab_hint_5", -1, -1, CVector(2742.219, 254.374, 1585.169), Quaternion(0.1124, 0.8274, 0.0585, 0.5471), 0)
			CreateNewDummyObject("arena_barricade12", "lab_hint_6", -1, -1, CVector(2311.921, 269.799, 1602.510), Quaternion(-0.0021, 0.0009, -1.0000, -0.0044), 0)
			CreateNewDummyObject("arena_barricade12", "lab_hint_7", -1, -1, CVector(2356.846, 268.765, 1319.912), Quaternion(0.0000, 0.7071, 0.0000, 0.7071), 0)
			CreateNewDummyObject("arena_barricade12", "lab_hint_8", -1, -1, CVector(1726.557, 267.825, 1611.884), Quaternion(-0.0022, 0.0065, 1.0000, 0.0004), 0)
			CreateNewDummyObject("arena_barricade12", "lab_hint_9", -1, -1, CVector(1708.955, 254.518, 1707.441), Quaternion(0.0000, -0.7056, 0.0000, 0.7086), 0)
			CreateNewDummyObject("arena_barricade12", "lab_hint_10", -1, -1, CVector(1815.065, 264.666, 1774.611), Quaternion(-0.0153, -0.9999, 0.0065, 0.0001), 0)
			CreateNewDummyObject("arena_barricade12", "lab_hint_11", -1, -1, CVector(2169.147, 255.019, 2386.642), Quaternion(-0.7036, 0.7069, 0.0494, -0.0523), 0)
			CreateNewDummyObject("arena_barricade12", "lab_hint_12", -1, -1, CVector(2189.314, 268.338, 2905.119), Quaternion(-0.7056, 0.0015, -0.7086, -0.0015), 0)
			CreateNewDummyObject("arena_barricade12", "lab_hint_13", -1, -1, CVector(1716.701, 255.045, 2839.950), Quaternion(-0.0515, 0.0446, -0.7172, 0.6935), 0)
			CreateNewDummyObject("arena_barricade12", "lab_hint_14", -1, -1, CVector(1487.224, 266.004, 2535.789), Quaternion(0.0000, 0.0044, 1.0000, -0.0001), 0)
			CreateNewDummyObject("arena_barricade12", "lab_hint_15", -1, -1, CVector(2356.340, 268.858, 1654.521), Quaternion(0.7071, -0.0031, -0.7071, -0.0031), 0)
			CreateNewDummyObject("arena_barricade12", "lab_hint_16", -1, -1, CVector(1696.345, 266.867, 2655.719), Quaternion(-0.7071, -0.0015, 0.7071, -0.0015), 0)

			AddImportantFadingMsgId("fm_easy_mode_on")
		</script>
	</trigger>

	<!-- Завал входа в лабиринт -->
	<trigger Name="trExitExplosion" active="0">
		<event eventid="GE_OBJECT_ENTERS_LOCATION" ObjName="Explos_loc" />
		<script>
			CreateNewDummyObject( "concrete_plate", "obval", -1, -1, CVector(3150.602, 282.007, 2113.764), Quaternion(0.0651, -0.0845, 0.6070, 0.7875), 0)

			CreateEffectInsertedInRemove( "ET_PS_VEH_EXP1_MED1", CVector(3143.630, 255.000, 2116.092), Quaternion(0.0000, 0.0000, 0.0000, 1.0000), true )

			trigger:Deactivate()
		</script>
	</trigger>

	<!-- Подрыв машины игрока, если он всё ещё в лабиринте -->
	<trigger Name="PlayerDieOrNot" active="0">
		<event	timeout="420"		eventid="GE_TIME_PERIOD" />
		<script>
			if QuestStatus("LastIspytanie_Quest3")==Q_TAKEN then
				GetPlayerVehicle():AddModifier( "hp", "= 0" )
				local file, error, code = io.open("data\\maps\\r1m7\\labyrinth.txt", "w")
			end

			trigger:Deactivate()
		</script>
	</trigger>

	<!-- Таймер -->
	<trigger Name="Timer1" active="0">
		<event	timeout="0.01"		eventid="GE_TIME_PERIOD" />
		<script>
			AddImportantFadingMsgByStrIdFormatted( "fm_death_count_0", 420)

			if QuestStatus("LastIspytanie_Quest3")==Q_TAKEN then
				TActivate("Timer2")
			end

			trigger:Deactivate()
		</script>
	</trigger>

	<trigger Name="Timer2" active="0">
		<event	timeout="60"		eventid="GE_TIME_PERIOD" />
		<script>
			AddImportantFadingMsgByStrIdFormatted( "fm_death_count_0", 360)

			if QuestStatus("LastIspytanie_Quest3")==Q_TAKEN then
				TActivate("Timer3")
			end

			trigger:Deactivate()
		</script>
	</trigger>

	<trigger Name="Timer3" active="0">
		<event	timeout="60"		eventid="GE_TIME_PERIOD" />
		<script>
			AddImportantFadingMsgByStrIdFormatted( "fm_death_count_0", 300)
			
			if QuestStatus("LastIspytanie_Quest3")==Q_TAKEN then
				TActivate("Timer4")
			end

			trigger:Deactivate()
		</script>
	</trigger>

	<trigger Name="Timer4" active="0">
		<event	timeout="60"		eventid="GE_TIME_PERIOD" />
		<script>
			AddImportantFadingMsgByStrIdFormatted( "fm_death_count_0", 240)

			if QuestStatus("LastIspytanie_Quest3")==Q_TAKEN then
				TActivate("Timer5")
			end

			trigger:Deactivate()
		</script>
	</trigger>

	<trigger Name="Timer5" active="0">
		<event	timeout="60"		eventid="GE_TIME_PERIOD" />
		<script>
			AddImportantFadingMsgByStrIdFormatted( "fm_death_count_0", 180)

			if QuestStatus("LastIspytanie_Quest3")==Q_TAKEN then
				TActivate("Timer6")
			end

			trigger:Deactivate()
		</script>
	</trigger>

	<trigger Name="Timer6" active="0">
		<event	timeout="60"		eventid="GE_TIME_PERIOD" />
		<script>
			AddImportantFadingMsgByStrIdFormatted( "fm_death_count_0", 120)

			if QuestStatus("LastIspytanie_Quest3")==Q_TAKEN then
				TActivate("Timer7")
			end

			trigger:Deactivate()
		</script>
	</trigger>

	<trigger Name="Timer7" active="0">
		<event	timeout="60"		eventid="GE_TIME_PERIOD" />
		<script>
			AddImportantFadingMsgByStrIdFormatted( "fm_death_count_0", 60)

			if QuestStatus("LastIspytanie_Quest3")==Q_TAKEN then
				TActivate("Timer8")
			end

			trigger:Deactivate()
		</script>
	</trigger>

	<trigger Name="Timer8" active="0">
		<event	timeout="58"		eventid="GE_TIME_PERIOD" />
		<script>
			AddImportantFadingMsgByStrIdFormatted( "fm_death")

			trigger:Deactivate()
		</script>
	</trigger>

	<!-- Игрок нашёл выход из лабиринта -->
	<trigger Name="trExitLabirint" active="0">
		<event eventid="GE_OBJECT_ENTERS_LOCATION" ObjName="LabExit_loc" />
		<script>
			AllowSave(true)

			CompleteQuest("LastIspytanie_Quest3")

			for trigger = 2,8 do
				TDeactivate("Timer"..trigger)
			end

			TDeactivate("PlayerDieOrNot")

			TActivate("KonRolikBegin")

			AllowSave(true)

			trigger:Deactivate()
		</script>
	</trigger>

	<!-- Смена машины с лабиринтской на машину игрока -->
	<trigger	Name="PlayerChange11"	active="0">
		<event	timeout="0.001"		eventid="GE_TIME_PERIOD" />
		<script>
			local excarname="OldCarPlayer2"
			local oldcarname="LABCAR"
			local veh=getObj(excarname)
			local oldveh=GetPlayerVehicle()

			if veh then
				GetPlayerVehicle():setGodMode(1)
				GetPlayerVehicle():SetCustomControlEnabled(1)
				CapturePlayerVehicle(0, "garage")
   				g_Player:AddChild(veh)
				GetPlayerVehicle():setGodMode(1)
				GetPlayerVehicle():SetCustomControlEnabled(0)
			end

			if oldveh then
			   oldveh:setGodMode(0)
			end

			RestoreWeaponGroups()

			GetPlayerVehicle():setGodMode(0)
			GetPlayerVehicle():setImmortalMode(0)

			PassToMap("r1m5", "FromR1M6JD", -1 , 1)

			trigger:Deactivate()
		</script>
	</trigger>
</triggers>