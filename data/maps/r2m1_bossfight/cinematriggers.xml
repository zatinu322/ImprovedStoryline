<?xml version="1.0" encoding="windows-1251" standalone="yes" ?>
<triggers>
<!-- смерть НЛО -->
	<trigger Name="RolikBegin_UFODIE" active="0">
		<event timeout="0" eventid="GE_TIME_PERIOD" />
		<script>
			PlayCustomMusic("Passage04")

			SaveAllToleranceStatus(RS_NEUTRAL)

			local ufo = GetEntityByName("AliensShip")
			local ufopos = ufo:GetPosition()
			local ufoID = ufo:GetId()
			
			Fly("UFODIE_cam01", CINEMATIC_NO_AIM, 0, 8, 1, 0)
			Fly("UFODIE_cam02", CINEMATIC_AIM_TO_ID, ufoID, 5, 0, 0 )
			Fly("UFODIE_cam032", CINEMATIC_NO_AIM, 0, 6, 0, 0 )
			Fly("UFODIE_cam031", CINEMATIC_NO_AIM, 0, 6, 0, 0 )

			if BookExists("r1_book_doklad") then
				local pcar = CreateVehicleEx("FelixVehicle2", "ProfessorCar", CVector(2693.961, 285.541, 1732.479), 1009, Quaternion(0.000, 0.522, 0.000, 0.853))
				local pcarId = pcar:GetId()

				RuleConsole("cinematic_spring_coeff 6.0")

				Fly("UFODIE_cam04", CINEMATIC_NO_AIM, 0, 16, 0, 0 )
				FlyLinked("AfterBattle", pcarId, 11, 0, 1, GetPlayerVehicleId())
				StartCinematic()

				TActivate("trAfterBattle")
			else
				Fly("UFODIE_cam04", CINEMATIC_NO_AIM, 0, 16, 0, 1 )
				StartCinematic()
			end

			CreateEffectTTLed("ET_S_UFODEATH", CVector(ufopos), Quaternion(0.0000, 0.0000, 0.0000, 1.0000), 30000)

			TActivate("RolikEnd_UFODIE")
			TActivate("trUFODIE_EF")
			TActivate("trUFODIE_cam02")
			TActivate("trUFODIE_cam04")
			TActivate("trUFODIE_FADE")
			
			AllowSave(true)

			trigger:Deactivate()
		</script>
	</trigger>

	<trigger Name="trUFODIE_FADE" active="0">
		<event eventid="GE_CINEMATIC_ENTER_FADE_IN" ObjName="Player1" />
		<script>
			local moverId = CreateNewObject { prototypeName	= "cinematicMover", objName  = "ufoMover" }
			local mover = GetEntityByID( moverId ) 
			local controlledObj = GetEntityByName("AliensShip")
			if controlledObj then
				controlledObj:SetRotation(Quaternion(0.004, -0.683, -0.009, 0.730))
				mover:SetObjAndPath( controlledObj:GetId(), "bossMove1", 30 )
			end
			
			local vehPlayer = GetPlayerVehicle()
			if vehPlayer then
				vehPlayer:SetCustomControlEnabled( true )
				vehPlayer:SetCustomLinearVelocity( 0 )
				vehPlayer:SetThrottle( 0 )
				vehPlayer:SetCustomControlEnabled( false )
				vehPlayer:SetGamePositionOnGround( CVector(2795.072, 284.827, 1836.845))
				vehPlayer:SetRotation(Quaternion(0.000, -0.952, -0.000, 0.306))
			end

			trigger:Deactivate()
		</script>
	</trigger>

	<trigger Name="trUFODIE_EF" active="0">
		<event timeout="0.1" eventid="GE_TIME_PERIOD" />
		<script>
			local ufo = GetEntityByName("AliensShip")
			local ufoPos = ufo:GetPosition()

			if (ufoPos.x > 1721) and (1729 > ufoPos.x) and (ufoPos.z > 1726 ) and (1734 > ufoPos.z ) then
				CreateNewSgNodeObject("ET_PS_ROCKS1", "boom01", -1, -1, CVector(1697.341, 463.358, 1706.809), Quaternion(0.078, 0.855, 0.496, 0.134))
				CreateNewSgNodeObject("ET_PS_DRONE_EX", "boom011", -1, -1, CVector(1697.341, 463.358, 1706.809), Quaternion(0.078, 0.855, 0.496, 0.134))
			end

			if (ufoPos.x > 1810) and (1818 > ufoPos.x) and (ufoPos.z > 1654 ) and ( 1662 > ufoPos.z ) then
				CreateNewSgNodeObject("ET_PS_ROCKS1", "boom02", -1, -1, CVector(1808.321, 412.275, 1578.256), Quaternion(0.078, 0.855, 0.496, 0.134))
				CreateNewSgNodeObject("ET_PS_DRONE_EX", "boom022", -1, -1, CVector(1808.321, 412.275, 1578.256), Quaternion(0.078, 0.855, 0.496, 0.134))
			end

			if (ufoPos.x > 1903) and (1911 > ufoPos.x) and (ufoPos.z > 1594 ) and (1602 > ufoPos.z ) then
				CreateNewSgNodeObject("ET_PS_AIRWAVE", "boom03", -1, -1, CVector(1943.270, 295.807, 1407.104), Quaternion(0.078, 0.855, 0.496, 0.134))
				CreateNewSgNodeObject("ET_PS_BIG_SMOKE12", "boom031", -1, -1, CVector(1943.270, 295.807, 1407.104), Quaternion(0.078, 0.855, 0.496, 0.134))
				CreateNewSgNodeObject("ET_PS_BIG_SMOKE12", "boom032", -1, -1, CVector(1943.270, 295.807, 1407.104), Quaternion(0.078, 0.855, 0.496, 0.134))
				trigger:Deactivate()
			end
		</script>
	</trigger>

	<trigger Name="trUFODIE_cam02" active="0">
		<event flypath="UFODIE_cam02" eventid="GE_START_CINEMATIC_FLY" ObjName="Player1" />
		<script>
			local station = GetEntityByName("AliensShipStation3")
			if station then station:Remove() end

			trigger:Deactivate()
		</script>
	</trigger>

	<trigger Name="trUFODIE_cam04" active="0">
		<event flypath="UFODIE_cam04" eventid="GE_START_CINEMATIC_FLY" ObjName="Player1" />
		<script>
			AddCinematicMessage( 131, 9 )

			CreateEffectTTLed("ET_S_UFODEATH", CVector(camPos), Quaternion(0.0000, 0.0000, 0.0000, 1.0000), 30000)

			trigger:Deactivate()
		</script>
	</trigger>

	<trigger Name="trAfterBattle" active="0">
		<event flypath="AfterBattle" eventid="GE_START_CINEMATIC_FLY" ObjName="Player1" />
		<script>
			PlayCustomMusic("Bio06")
			
			local pcar = GetEntityByName("ProfessorCar")
			if pcar then
				pcar:SetSkin(1)
				pcar:SetGamePositionOnGround(CVector(2693.961, 285.541, 1732.479))
				pcar:SetRotation(Quaternion(0.000, 0.522, 0.000, 0.853))
				pcar:SetExternalPathByName("AfterBattle_path01")
				pcar:SetCustomLinearVelocity( 13 )
				pcar:SetCruisingSpeed(13)
				pcar:SetMaxSpeed(13)
			end

				trigger:Deactivate()
		</script>
	</trigger>

	<trigger Name="RolikEnd_UFODIE" active="0">
		<event eventid="GE_END_CINEMATIC" ObjName="Player1" />
		<event eventid="GE_SKIP_CINEMATIC" ObjName="Player1" />
		<script>

			RestoreAllToleranceStatus()
		
			TDeactivate("trUFODIE_FADE")	
			TDeactivate("trUFODIE_EF")
			TDeactivate("trUFODIE_cam02")
			TDeactivate("trUFODIE_cam04")
			TDeactivate("trAfterBattle")
			
			TActivate("VyborFinala")
			TActivate("trUFODIE_PlaceUfo")

			local vehPlayer = GetPlayerVehicle()
			if vehPlayer then
				vehPlayer:SetGamePositionOnGround( CVector(2795.072, 284.827, 1836.845))
				vehPlayer:SetRotation(Quaternion(0.000, -0.952, -0.000, 0.306))
			end

			local mover = GetEntityByName("ufoMover")
			if mover then mover:Remove() end

			StopPlayingCustomMusic()

			SetCameraBehindPlayerVehicle()
			
			if BookExists( "r1_book_doklad" ) then
				local pcar = GetEntityByName("ProfessorCar")
				if pcar then
					pcar:PlaceToEndOfPath("AfterBattle_path01")
					pcar:SetGamePositionOnGround( CVector(2772.473, 286.377, 1791.452))
		   			pcar:SetRotation(Quaternion(-0.000, 0.216, 0.000, 0.976))
					pcar:setGodMode(1)
					pcar:setImmortalMode(1)
					pcar:SetExternalPathByName("AfterBattle_path02")
				end

				RuleConsole("cinematic_spring_coeff 0.7")
			
				StartConversation("ProfessorMal")
			else
				TActivate("ToR2M1AfterBoss")
			end

			trigger:Deactivate()
		</script>
	</trigger>

	<!-- Ставим НЛО на последнюю позицию отдельно, так как не работает в триггере завершения -->
	<trigger Name="trUFODIE_PlaceUfo" active="0">
		<event	timeout="0.01"		eventid="GE_TIME_PERIOD" />
		<script>
			local ufo = GetEntityByName("AliensShip")
			if ufo then
				ufo:SetPosition(CVector(1900.168, 280.978, 1610.655))
				ufo:SetRotation(Quaternion(0.179, 0.810, -0.266, -0.491))
			end

			trigger:Deactivate()
		</script>
	</trigger>
</triggers>