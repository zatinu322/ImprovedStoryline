<?xml version="1.0" encoding="windows-1251" standalone="yes" ?>
<triggers>
	<!-- Инициализация карты -->
	<trigger	Name="GlobalVar"	active="1">
		<event timeout="0.1" eventid="GE_TIME_PERIOD" />
		<script>
			SetVar("globalCaravanToPorto",0)
			SetVar("globalCaravanToMidgard",0)
			SetVar("FindBen",1)
			SetVar("KnownMap",0)
			SetVar("NoChifir",1)
			SetVar("Player4eeter",0)
			if GAME_VERSION then SetVar("ISLVersion", GAME_VERSION) end

			local shl = GetEntityByName("MisterShlyapaFM")
			if shl then
				shl:SetProperty("Active",0)
			end

			CreateNewDummyObject( "big_gate01", "ThePortoGates", -1, -1, CVector(6683.363, 48.874, 6502.228), Quaternion(0.000, -0.692, 0.000, 0.722), 0)
			getObj("ThePortoGates"):SetNodeAction(AT_RESERVED3)
			
			TActivate("SpawnPortoGates")

			trigger:Deactivate()
		</script>
	</trigger>

	<!-- Создание фейк-ворот для Порто -->
	<trigger Name="SpawnPortoGates" active="0">
		<event eventid="GE_GAME_START" ObjName="Player1" />
		<script>
			local pgates = getObj("ThePortoGates")
			if pgates then
				pgates:SetNodeAction(AT_RESERVED3)
			end

		</script>
	</trigger>

	<!-- Раскладка случайного оружия в ящики -->
	<trigger	Name="trRidzinPlaceSecret"	active="1">
		<event	timeout="0.1"			eventid="GE_TIME_PERIOD" />
		<script>
			local gunlist = {"specter01","pkt01","kord01","hornet01","storm01","hurricane01","vulcan01"}
			local len = getn(gunlist)

			for i=1,10 do
				--println("step"..i.."succesful")
				CreateBoxWithAffixGun(CVector(getPos("SecretPlace"..i.."_loc")), gunlist[exrandom(len)], random(0, 2))
			end
			trigger:Deactivate()
		</script>
	</trigger>

	<!-- Караван Мидгард - Порто -->
	<trigger Name="trCaravanToPorto" active="0">
		<event timeout="0" eventid="GE_TIME_PERIOD" />
		<script>
			CreateVehicleEx("r1m3_CaravanMolokovoz01","KARAVANPORTO_vehicle_0", CVector(4340.774, 260, 881.814), 1009)
			if GetEntityByName("KARAVANPORTO_vehicle_0") then GetEntityByName("KARAVANPORTO_vehicle_0"):SetRandomSkin() end

			SetTolerance(1100,1009,RS_ALLY)

			TakeQuest("d_CaravanToPortoBen_Quest")

			TActivate( "trCaravanToPorto5sec" )
			TActivate( "trCaravanToPortoINPLACE" )
			TActivate( "trCaravanToPortoDIE" )
			TActivate( "trCaravanToPortoLength" )

			trigger:Deactivate()
		</script>
	</trigger>

	<trigger Name="trCaravanToPorto5sec" active="0">
		<event timeout="5" eventid="GE_TIME_PERIOD" />
		<script>
			GetEntityByName("KARAVANPORTO_vehicle_0"):SetExternalPathByName("MtoP_path")

			trigger:Deactivate()
		</script>
	</trigger>

	<trigger Name="trCaravanToPortoINPLACE" active="0">
		<event eventid="GE_OBJECT_ENTERS_LOCATION" ObjName="PortoQ" />
		<script>
			SetVar("globalCaravanToPorto",1)

			GetEntityByName("KARAVANPORTO_vehicle_0"):setGodMode(1)
			GetEntityByName("KARAVANPORTO_vehicle_0"):setImmortalMode(1)
			TDeactivate( "trCaravanToPortoDIE" )
			TDeactivate( "trCaravanToPortoLength" )

			trigger:Deactivate()
		</script>
	</trigger>

	<trigger Name="trCaravanToPortoDIE" active="0">
		<event eventid="GE_OBJECT_DIE" ObjName="KARAVANPORTO_vehicle_0" />
		<script>
			FailQuestIfTaken( "FindBen2_Quest" )

			TActivate("cinCaravanDead")
			TDeactivate( "trCaravanToPorto5sec" )
			TDeactivate( "trCaravanToPortoLength" )
			TDeactivate("trCaravanToPortoINPLACE")

			SetTolerance(1100,1009,RS_NEUTRAL)

			trigger:Deactivate()
		</script>
	</trigger>

	<trigger Name="trCaravanToPortoLength" active="0">
		<event timeout="1" eventid="GE_TIME_PERIOD" />
		<script>
			local run = GetEntityByName("KARAVANPORTO_vehicle_0")
			local pl = GetPlayerVehicle()
			local len

			if run and run:IsAlive() then
				len = Dist(pl, run)
				if (len > 75) then
					run:SetCustomLinearVelocity( 0 )
					run:SetThrottle( 0 )
				end
			end
		</script>
	</trigger>

	<!-- Караван Порто - Мидгард -->
	<trigger Name="trCaravanToMidgard" active="0">
		<event timeout="0" eventid="GE_TIME_PERIOD" />
		<script>
			if GetEntityByName("KARAVANPORTO_vehicle_0") then 
				kskin = GetEntityByName("KARAVANPORTO_vehicle_0"):GetSkin()
				GetEntityByName("KARAVANPORTO_vehicle_0"):Remove()
			end

			CreateVehicleEx("r1m3_CaravanMolokovoz02","KARAVANMIDGARD_vehicle_0", CVector(6797.209, 260, 6501.624), 1009)
			if kskin and GetEntityByName("KARAVANMIDGARD_vehicle_0") then GetEntityByName("KARAVANMIDGARD_vehicle_0"):SetSkin(kskin) end
			kskin = nil

			TakeQuest("d_CaravanToMidgardBen_Quest")

			TActivate( "trCaravanToMidgard5sec" )
			TActivate( "trCaravanToMidgardINPLACE" )
			TActivate( "trCaravanToMidgardDIE" )
			TActivate( "trCaravanToMidgardLength" )

			trigger:Deactivate()
		</script>
	</trigger>

	<trigger Name="trCaravanToMidgard5sec" active="0">
		<event timeout="5" eventid="GE_TIME_PERIOD" />
		<script>
			GetEntityByName("KARAVANMIDGARD_vehicle_0"):SetExternalPathByName("PtoM_path")

			trigger:Deactivate()
		</script>
	</trigger>

	<trigger Name="trCaravanToMidgardINPLACE" active="0">
		<event eventid="GE_OBJECT_ENTERS_LOCATION" ObjName="MidragdQ" />
		<script>
			SetVar("globalCaravanToMidgard",1)

			GetEntityByName("KARAVANMIDGARD_vehicle_0"):setGodMode(1)
			GetEntityByName("KARAVANMIDGARD_vehicle_0"):setImmortalMode(1)
			TDeactivate( "trCaravanToMidgardDIE" )
			TDeactivate( "trCaravanToMidgardLength" )

			trigger:Deactivate()
		</script>
	</trigger>

	<trigger Name="trCaravanToMidgardDIE" active="0">
		<event eventid="GE_OBJECT_DIE" ObjName="KARAVANMIDGARD_vehicle_0" />
		<script>
			FailQuestIfTaken( "FindBen2_Quest" )

			TActivate("cinCaravanDead")
			TDeactivate("trCaravanToMidgardINPLACE")
			TDeactivate( "trCaravanToMidgard5sec" )
			TDeactivate( "trCaravanToMidgardLength" )

			SetTolerance(1100,1009,RS_NEUTRAL)

			trigger:Deactivate()
		</script>
	</trigger>

	<trigger Name="trCaravanToMidgardLength" active="0">
		<event timeout="1" eventid="GE_TIME_PERIOD" />
		<script>
			local run = GetEntityByName("KARAVANMIDGARD_vehicle_0")
			local pl = GetPlayerVehicle()
			local len

			if run and run:IsAlive() then
				len = Dist(pl, run)
				if (len > 75) then
					run:SetCustomLinearVelocity( 0 )
					run:SetThrottle( 0 )
				end
			end
		</script>
	</trigger>

	<trigger Name="trCaravanToMidgardRemove" active="0">
		<event timeout="0" eventid="GE_TIME_PERIOD" />
		<script>
			GetEntityByName("KARAVANMIDGARD_vehicle_0"):Remove()

			trigger:Deactivate()
		</script>
	</trigger>

	<!-- Закрытие/открытие Мидгарда -->
	<trigger	Name="trMidgardCloses"	active="0">
		<event timeout="0" eventid="GE_TIME_PERIOD" />
		<script>
			local tp = GetEntityByName("Midragd")
			tp:SetOpenGateToPlayer( false )

			SetConditionalClosingForTown( "Midragd", "r1m2", true )

			CreateNewDummyObject("midgard_gate", "MidgragdGates", -1, -1, CVector(4344.384, 128.562, 833.465), Quaternion(0.000, 1.000, 0.000, 0.009), 0)

			trigger:Deactivate()
 		</script>
	</trigger>

	<trigger	Name="trMidgardOpens"	active="0">
		<event timeout="0" eventid="GE_TIME_PERIOD" />
		<script>
			local tp = GetEntityByName("Midragd")
			tp:SetOpenGateToPlayer( true )

			SetConditionalClosingForTown( "Midragd", "r1m2", false )

			local midG = GetEntityByName("MidgragdGates")
			if midG then midG:Remove() end

			trigger:Deactivate()
 		</script>
	</trigger>

	<!-- Очистка склада Сальваторе от рейдеров -->
	<trigger Name="RaidersToKill" active="0">
		<event timeout="0" eventid="GE_TIME_PERIOD" />
		<script>

			TeamCreate("CarOfRaider",1002,CVector(6471.031, 73.844, 546.496),{"DemoMolokovoz1","Scout03"})

			TakeQuest("BenMZ2_Quest")

			TActivate ("RaidersDie")
			
			trigger:Deactivate()
		</script>
	</trigger>

	<trigger Name="RaidersDie" active="0">
		<event eventid="GE_OBJECT_DIE" ObjName="CarOfRaider" />
		<script>
			CompleteQuest( "BenMZ2_Quest" )

			TActivate ("cinAfterKillRaider")

			trigger:Deactivate()
		</script>
	</trigger>

	<!-- Подъезжаем к лагерю бандитов, у которых караванщик Стрыги -->
	<trigger Name="PLENLISA" active="0">
		<event eventid="GE_OBJECT_ENTERS_LOCATION" ObjName="LisaInBanditPlen" />
		<script>
			TActivate( "RolikPlenlisa" )

			CompleteQuest( "BenRim3_Quest" )

			trigger:Deactivate()
		</script>
	</trigger>

	<!-- Убили бандитов, спасли караванщика -->
	<trigger Name="PLENLISADIE" active="0">
		<event eventid="GE_OBJECT_DIE" ObjName="LisaInBanditDen" />
		<script>
			CompleteQuest( "BenRim4_Quest" )

			TakeQuest( "d_FindHouseOfBen_Quest" )

			TActivate( "RolikBegin_LisaPlenDie" )

			SetVar("FindBen",0)

			trigger:Deactivate()
		</script>
	</trigger>

<!-- Подъезд к дому Бена -->
	<trigger Name="tr_THEBEN" active="1">
		<event eventid="GE_OBJECT_ENTERS_LOCATION" ObjName="TheBen_House" />
		<script>
			if ((GetVar("FindBen").AsInt==1) 
				or QuestStatus("d_FindHouseOfBen_Quest")==Q_TAKEN 
				or QuestStatus("TalkBeforeDesert")==Q_TAKEN 
				or QuestStatus("BenBadEnd")==Q_TAKEN 
				or QuestStatus("LisaUBena")==Q_TAKEN 
				or QuestStatus("r4m2_LisaDieBen")==Q_TAKEN 
				or QuestStatus("BenZima_Quest")==Q_TAKEN 
				or QuestStatus("BenNormalEnd")==Q_TAKEN 
				or QuestStatus("BenGoodEnd")==Q_TAKEN) then

				TActivate("RolikBegin_BenHause")

				trigger:Deactivate()
			end
		</script>
	</trigger>

	<!-- Ждём, пока Сальваторе откроет Мидгард -->
	<trigger Name="WaitForThief" active="0">
		<event	timeout="30"		eventid="GE_TIME_PERIOD" />
		<script>
			CompleteQuest("OpenMid11_Quest")

			trigger:Deactivate()
		</script>
	</trigger>

	<!-- Машина Лисы возле дома Бена. -->
	<trigger	Name="LisaBen"	active="0">
		<event	timeout="1"		eventid="GE_TIME_PERIOD" />
		<script>
			CreateVehicleEx("LisaCar","CARLISAS",CVector(3769.095, 117.979, 1777.622), 1042)
			
			local vehLisa = GetEntityByName("CARLISAS")
			if vehLisa then
				vehLisa:SetRotation(Quaternion(-0.017, -0.738, 0.014, -0.674))
				vehLisa:SetSkin(2)
				vehLisa:setImmortalMode(1)
			end

			trigger:Deactivate()
		</script>
	</trigger>

	<!-- Плохая концовка -->
	<trigger Name="StartBadEnd" active="0">
		<event	timeout="0"		eventid="GE_TIME_PERIOD" />
		<script>
			SetGameTime( 10, 0 )
			TActivate("BadEndingBegin")
			TActivate("BenExplode")

			trigger:Deactivate()
		</script>
	</trigger>

	<!-- Нормальная концовка -->
	<trigger Name="ToFaterEnd" active="0">
		<event	timeout="3"		eventid="GE_TIME_PERIOD" />
		<script>
			
			AutoSave( "" )
			
			PassToMap("r1m3", "locNormalEnd", -1 )

			trigger:Deactivate()
		</script>
	</trigger>

	<!-- Бонусная концовка -->
	<trigger Name="ToSpecEnd" active="0">
		<event	timeout="1"		eventid="GE_TIME_PERIOD" />
		<script>
			
			AutoSave( "" )
			
			PassToMap("r1m8", "FromR1M2", -1 )

			trigger:Deactivate()
		</script>
	</trigger>

	<trigger Name="trBenDialogActivate" active="0">
		<event        timeout="3"        eventid="GE_TIME_PERIOD" />
		<script>
			if GetVar("Player4eeter").AsInt == 1 then
				g_Console:InputLine "\\quit"
			else
				CheckPlayerVehicle()
			end
		</script>
	</trigger>

	<!-- Начало всех битв в Колизее -->
	<trigger Name="KOLIZEYFIGHT" active="0">
		<event eventid="GE_OBJECT_ENTERS_LOCATION" ObjName="Kolizey_location" />
		<script>
			if QuestStatus("CombatInKollizey_Quest1")==Q_TAKEN then
				TActivate( "RolikBegin_Kolizey1" )

				trigger:Deactivate()
			end

			if QuestStatus("r1m2_Glagiators_Quest1")==Q_TAKEN then
				TActivate( "RolikBegin_Kolizey2" )

				trigger:Deactivate()
			end
		</script>
	</trigger>

	<!-- Завершение битв в Колизее -->
	<trigger Name="KOLIZEYFIGHTDIE1" active="0">
		<event eventid="GE_OBJECT_DIE" ObjName="Gladiator1" />
		<script>
			
			TActivate("ROLIK_KOLIZEYFIGHTDIE")

			trigger:Deactivate()
		</script>
	</trigger>

	<trigger Name="KOLIZEYFIGHTDIE2" active="0">
		<event eventid="GE_OBJECT_DIE" ObjName="Gladiator2" />
		<script>
			
			TActivate("ROLIK_KOLIZEYFIGHTDIE")

			trigger:Deactivate()
		</script>
	</trigger>

	<!-- Квесты с археологами. Помощь/похищение. -->
	<trigger Name="ANTICWAR" active="0">
		<event timeout="0" eventid="GE_TIME_PERIOD" />
		<script>
			TeamCreate("CarOfAntiSiencer",1002,CVector(7468.556, 184.763, 5213.779),{"DemoBandit"}, nil, 1)

			TakeQuest("HelpRuins_Quest")

			TActivate("RUINSWAR")

			trigger:Deactivate()
		</script>
	</trigger>

	<trigger Name="ANTISIENCER" active="0">
		<event timeout="0" eventid="GE_TIME_PERIOD" />
		<script>
			TeamCreate("CarOfSiencer",1032,CVector(7468.556, 184.763, 5213.779),{"r1m1_bug02"}, nil, 1)

			TakeQuest("DestroyRuins_Quest")

			TActivate("RUINSWAR")

			trigger:Deactivate()
		</script>
	</trigger>

	<trigger Name="RUINSWAR" active="0">
		<event eventid="GE_OBJECT_DIE" ObjName="CarOfAntiSiencer" />
		<event eventid="GE_OBJECT_DIE" ObjName="CarOfSiencer" />
		<script>
			if QuestStatus("HelpRuins_Quest")==Q_TAKEN then
				CompleteQuest( "HelpRuins_Quest" )

			elseif QuestStatus("DestroyRuins_Quest")==Q_TAKEN then
				CompleteQuest( "DestroyRuins_Quest" )
				TakeQuest( "DestroyRuins2_Quest" )

				TActivate("cinAfterKidnapping")
			end

			trigger:Deactivate()
		</script>
	</trigger>

	<!-- Переход в Край -->
	<trigger Name="triggerExitToMap11" active="1">
		<event eventid="GE_OBJECT_ENTERS_LOCATION" ObjName="ToR1M1" />
		<script>
			local Plf = GetPlayerVehicle()
			Plf:SetThrottle( 0 )
			Plf:SetCustomLinearVelocity( 0 )

			local PlfID = GetPlayerVehicleId()
			local PlfCoor = Plf:GetPosition()
			PlfCoor.y = PlfCoor.y + 25*0.74
			PlfCoor.z = PlfCoor.z + 25*0.74

			if QuestStatus("d_CaravanToPortoBen_Quest")~=Q_TAKEN and QuestStatus("d_CaravanToMidgardBen_Quest")~=Q_TAKEN then
				ValidateGameVersion()

				local b = SpawnMessageBox( "8801" )
				if b == 1 then

					PassToMap("r1m1", "FromR1M2", -1 )

					if QuestStatus("SharkyVyshka")==Q_TAKEN then
						local vehLisa = GetEntityByName("CARLISAS")
						if vehLisa then
							vehLisa:Remove()
						end
					end
				else
					SaveAllToleranceStatus(RS_NEUTRAL)

					FlyAround(1, 0, 25, 3, PlfCoor, PlfID, 1, 1 )
					StartCinematic()

					TActivate ("RolikExitToMap11")
					TActivate ("RolikENDExitToMap11")
				end
			else
				SaveAllToleranceStatus(RS_NEUTRAL)

				FlyAround(1, 0, 25, 3, PlfCoor, PlfID, 1, 1 )
				StartCinematic()

				TActivate ("RolikExitToMap11")
				TActivate ("RolikENDExitToMap11")
			end
 		</script>
	</trigger>
	<trigger Name="RolikExitToMap11" active="0">
		<event eventid="GE_CINEMATIC_ENTER_FADE_IN" ObjName="Player1" />
		<script>
			RotationPlayerByPoints(CVector(getPos("ToR1M1")), CVector(getPos("FromR1M1")))
			GetPlayerVehicle():SetGamePositionOnGround(CVector(getPos("FromR1M1")))

			trigger:Deactivate()    
		</script>
	</trigger>
	<trigger Name="RolikENDExitToMap11" active="0">
		<event eventid="GE_END_CINEMATIC" ObjName="Player1" />
		<event eventid="GE_SKIP_CINEMATIC" ObjName="Player1" />
		<script>
			RestoreAllToleranceStatus()

			GetPlayerVehicle():SetGamePositionOnGround(CVector(getPos("FromR1M1")))

			TDeactivate( "RolikExitToMap11" )

			SetCameraBehindPlayerVehicle()

			trigger:Deactivate()
		</script>
	</trigger>

	<!-- Переход в Фатерлянд -->
	<trigger Name="triggerExitToMap13" active="1">
		<event eventid="GE_OBJECT_ENTERS_LOCATION" ObjName="ToR1M3" />
		<script>
			local Plf = GetPlayerVehicle()
			Plf:SetThrottle( 0 )
			Plf:SetCustomLinearVelocity( 0 )

			local PlfID = GetPlayerVehicleId()
			local PlfCoor = Plf:GetPosition()
			PlfCoor.y = PlfCoor.y + 25*0.74
			PlfCoor.z = PlfCoor.z + 25*0.74

			if IsQuestComplete("d_FindHouseOfBen_Quest") or IsQuestComplete("QuickFindBen") then 
				ValidateGameVersion()

				local b = SpawnMessageBox( "8801" )
				if b == 1 then

					PassToMap("r1m3", "FromR1M2", -1 )

					if QuestStatus("SharkyVyshka")==Q_TAKEN then
						local vehLisa = GetEntityByName("CARLISAS")
						if vehLisa then
							vehLisa:Remove()
						end
					end
				else
					SaveAllToleranceStatus(RS_NEUTRAL)

					FlyAround(1, 0, 25, 3, PlfCoor, PlfID, 1, 1 )
					StartCinematic()

					TActivate ("RolikExitToMap13")
					TActivate ("RolikENDExitToMap13")
				end
			else
				SaveAllToleranceStatus(RS_NEUTRAL)

				FlyAround(1, 0, 25, 6, PlfCoor, PlfID, 1, 1 )
				StartCinematic()

				AddCinematicMessage( 8802, 0.5 )

				TActivate ("RolikExitToMap13")
				TActivate ("RolikENDExitToMap13")
			end
 		</script>
	</trigger>
	<trigger Name="RolikExitToMap13" active="0">
		<event eventid="GE_CINEMATIC_ENTER_FADE_IN" ObjName="Player1" />
		<script>
			RotationPlayerByPoints(CVector(getPos("ToR1M3")), CVector(getPos("FromR1M3")))
			GetPlayerVehicle():SetGamePositionOnGround(CVector(getPos("FromR1M3")))

			trigger:Deactivate()    
		</script>
	</trigger>
	<trigger Name="RolikENDExitToMap13" active="0">
		<event eventid="GE_END_CINEMATIC" ObjName="Player1" />
		<event eventid="GE_SKIP_CINEMATIC" ObjName="Player1" />
		<script>
			RestoreAllToleranceStatus()

			GetPlayerVehicle():SetGamePositionOnGround(CVector(getPos("FromR1M3")))

			TDeactivate( "RolikExitToMap13" )

			SetCameraBehindPlayerVehicle()

			trigger:Deactivate()
		</script>
	</trigger>
</triggers>