<?xml version="1.0" encoding="windows-1251" standalone="yes" ?>
<triggers>
	<!-- Инициализация карты -->
	<trigger	Name="GlobalVar"	active="1">
		<event	timeout="0.1"		eventid="GE_TIME_PERIOD" />
		<script>
			SetVar("CountArmyKill",0)
			if GAME_VERSION then SetVar("ISLVersion", GAME_VERSION) end

			local test=0
			if test==1 then
				CompleteQuest("r4m1_RescueBuharsCivilian")
				TakeQuest("r4m1_GotoAivenGo")
			end
			
			trigger:Deactivate()
		</script>
	</trigger>

	<trigger	Name="trStartMap"	active="1">
		<event eventid="GE_GAME_START" ObjName="Player1" />
		<script>
			if QuestStatus("r4m2_FightWithCrazy")==Q_CANBEGIVEN then
				TActivate("trMoveToFatherCar")
				TActivate("trMoveToMilitaryBase")
				TActivate("trNearBase")

			   	CreateNewDummyObject( "arena_barricade8", "gate1", -1, -1, CVector(2443.522, 291.049, 1202.637), Quaternion(0.0000, -0.7102, 0.0000, 0.7040), 0)
				CreateNewDummyObject( "arena_barricade8", "gate2", -1, -1, CVector(2443.574, 291.070, 1197.132), Quaternion(0.0061, -0.7071, -0.0061, 0.7071), 0)
				CreateNewDummyObject( "mirotvorecCargo05", "mirCargo", -1, -1, CVector(1554.298, 329.958, 338.369), Quaternion(-0.0383, 0.7107, 0.0388, 0.7014), 8)
				CreateNewDummyObject( "mirotvorecCab05", "mirCab", -1, -1, CVector(1559.402, 329.696, 338.649), Quaternion(0.0278, 0.7066, -0.0278, 0.7066), 8)

				local Acab = GetEntityByName("mirCab")
				if Acab then Acab:SetBelong(1042) end

				local Acargo = GetEntityByName("mirCargo")
				if Acargo then Acargo:SetBelong(1042) end

				trigger:Deactivate()
			end
		</script>
	</trigger>

	<!-- Приблизились к базе безумцев -->
	<trigger	Name="trMoveToMilitaryBase"	active="0">
		<event	eventid="GE_OBJECT_ENTERS_LOCATION"	ObjName="MilitaryBase_loc"/>
		<script>
			if QuestStatus("r4m2_FightWithCrazy")==Q_CANBEGIVEN then
				TActivate("trActivateArmyDie")

				trigger:Deactivate()
			end
		</script>
	</trigger>

	<!-- Подъехали к базе безумцев -->
	<trigger	Name="trNearBase"	active="0">
		<event	eventid="GE_OBJECT_ENTERS_LOCATION"	ObjName="NearEnterBase_loc" />
		<script>

            TakeQuest("r4m2_FightWithCrazy")

			TActivate("cinNearBase")

			trigger:Deactivate()
		</script>
	</trigger>

	
	<!-- Счётчик убитых безумцев -->
	<trigger	Name="trMBArmy01Die"	active="0">
		<event	eventid="GE_OBJECT_DIE"	ObjName="MBArmy01" />
		<event	eventid="GE_OBJECT_DIE"	ObjName="MBArmy02" />
		<event	eventid="GE_OBJECT_DIE"	ObjName="MBArmy03" />
		<event	eventid="GE_OBJECT_DIE"	ObjName="MBArmy04" />
		<script>
			TActivate("trActivateArmyDie")

			trigger:Deactivate()
		</script>
	</trigger>

	<trigger	Name="trActivateArmyDie"	active="0">
		<event	timeout="0.5"		eventid="GE_TIME_PERIOD" />
		<script>
		    local count = GetVar("CountArmyKill").AsInt
			if count>=6 then
			   TActivate("trHelpers1")
			   TDeactivate("trMBArmy01Die")
			else
				for i = 1,4 do
					if getObj("MBArmy0"..i)==nil then
						count = count + 1
						local vehlist={"Tank01","Hunter01","Hunter02","Cruiser01","CruiserBased"}
						local veh1=vehlist[random(getn(vehlist))]
						local veh2=vehlist[random(getn(vehlist))]
						CreateTeam("MBArmy0"..i, 1062, CVector(getPos("SpawnCrazy"..random(17).."_loc")),{veh1,veh2},CVector(getPos("MilitaryBase_loc")))
					end
				end
				TActivate("trMBArmy01Die")
				SetVar("CountArmyKill", count)
			end
			trigger:Deactivate()
		</script>
	</trigger>

	<!-- Серго вмешивается в битву с безумцами -->
	<trigger	Name="trHelpers1"	active="0">
		<event	timeout="2"		eventid="GE_TIME_PERIOD" />
		<script>

			TActivate("cinHelpersFirst")

			local g1 = GetEntityByName("gate1")
			if g1 then g1:Remove() end
			local g2 = GetEntityByName("gate2")
			if g2 then g2:Remove() end

			trigger:Deactivate()
		</script>
	</trigger>

	<!-- Впервые подъехали к тарелке -->
	<trigger	Name="trNearPlate"	active="0">
		<event	eventid="GE_OBJECT_ENTERS_LOCATION"	ObjName="NearPlateRadiation_loc" />
		<script>

			TActivate("cinLookToTarelkaFirst")

			AddHistory( "r4_NearTarelka" )
			AddFadingMsgId( "fm_history_got" )

			CompleteQuest("r4m2_InvestigationPlate")

			trigger:Deactivate()
		</script>
	</trigger>

	<!-- Подъехали слишком близко к тарелке. Тупиковая концовка. -->
	<trigger	Name="trMoveToPlate"	active="1">
		<event	eventid="GE_OBJECT_ENTERS_LOCATION"	ObjName="PlateRadiation_loc" />
		<script>

			TActivate("cinPlateFirst")

			trigger:Deactivate()
		</script>
	</trigger>

	<!-- Доставили блокиратор Ньери к Повелителю -->
	<trigger	Name="BlokiratorPrivezli"	active="1">
		<event	eventid="GE_OBJECT_ENTERS_LOCATION"	ObjName="TarelkaEnd_loc" />
		<script>
			if IsQuestTaken("r4m2_BlokiratorToUFO") then
			
				TActivate("Blokiratorcin")
				
				trigger:Deactivate()
			end
			
		</script>
	</trigger>

	<!-- Переход в Край -->
	<trigger Name="trExitToR4M1" active="1">
		<event	eventid="GE_OBJECT_ENTERS_LOCATION"	ObjName="ExitFromMap" />
		<script>
			local Plf = GetPlayerVehicle()
			Plf:SetThrottle( 0 )
			Plf:SetCustomLinearVelocity( 0 )

			local PlfID = GetPlayerVehicleId()
			local PlfCoor = Plf:GetPosition()
			PlfCoor.x = PlfCoor.x - 10
			PlfCoor.y = PlfCoor.y + 5
			PlfCoor.z = PlfCoor.z + 15

			ValidateGameVersion()

			local b = SpawnMessageBox( "8801" )

			if b == 1 then
				PassToMap("r4m1", "FromR4M2", -1)
			else
				SaveAllToleranceStatus(RS_NEUTRAL)

				FlyAround(0.1, 0, 25, 3, PlfCoor, PlfID, 1, 1 )
				StartCinematic()

				TActivate ("trExitToR4M1_Fade")
				TActivate ("trExitToR4M1_End")
			end
 		</script>
	</trigger>
	<trigger Name="trExitToR4M1_Fade" active="0">
		<event eventid="GE_CINEMATIC_ENTER_FADE_IN" ObjName="Player1" />
		<script>
			
			local Plf = GetPlayerVehicle()
			Plf:SetThrottle( 0 )
			Plf:SetCustomLinearVelocity( 0 )

			trigger:Deactivate()    
		</script>
	</trigger>
	<trigger Name="trExitToR4M1_End" active="0">
		<event eventid="GE_END_CINEMATIC" ObjName="Player1" />
		<event eventid="GE_SKIP_CINEMATIC" ObjName="Player1" />
		<script>
			RestoreAllToleranceStatus()

			local Plf = GetPlayerVehicle()
			if Plf then
				Plf:SetGamePositionOnGround( CVector(591.563, 289.187, 3249.602))
				Plf:SetRotation(Quaternion(0.002, 0.948, 0.001, 0.319))
			end

			TDeactivate( "trExitToR4M1_Fade" )

			SetCameraBehindPlayerVehicle()

			trigger:Deactivate()
		</script>
	</trigger>
</triggers>
